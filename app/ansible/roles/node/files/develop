- name: setup nodejs12.x
  shell: curl -sL https://rpm.nodesource.com/setup_12.x | bash -

- name: installing 12.x version of node.js
  yum:
    name: nodejs
    state: latest

- name: Install packages based on package.json.
  npm:
    path: /opt/node

- name: Install "express" node.js package.
  npm:
    name: "{{ item }}"
    state: present
    path: /opt/node
  loop:
    - express

- name: Install "express-generator" "nodemon" "sequelize-cli" node.js package.
  npm:
    name: "{{ item }}"
    state: present
    global: yes
    path: /opt/node
  loop:
    - express-generator
    - typescript
    - nodemon
    - sequelize-cli

- name: run expressApp
  shell: express expressApp 
  args:
    chdir: /opt/node

- name: Install packages based on package.json.
  npm:
    path: /opt/node/expressApp

- name: Install "eslint","typescript" node.js package.
  npm:
    name: "{{ item }}"
    state: present
    path: /opt/node/expressApp
  loop:
    - "{{TYPESCRIPTESLINT}}"
    - "{{TYPESCRIPTESLINTPLUGIN}}"
    - "{{TYPESCRIPTNODE}}"
    - "{{TYPESCRIPTEXPRESS}}"
    - "{{TYPESCRIPTSEQUELIZE}}"
    - "{{TYPESCRIPTBCRYPT}}"
    - "{{TYPESCRIPTCOOKIEPARSER}}"
    - "{{TYPESCRIPTDEBUG}}"
    - "{{TYPESCRIPTJSONWEBTOKEN}}"
    - "{{TYPESCRIPTMORGAN}}"
    - "{{TYPESCRIPTPASSPORT}}"
    - "{{TYPESCRIPTPSJWT}}"
    - "{{TYPESCRIPTPSLOCAL}}"
    - "{{TYPESCRIPTVALI}}"
    - eslint
    - prettier
    - eslint-plugin-prettier
    - eslint-config-prettier
    - passport
    - passport-local
    - express-session
    - sequelize
    - body-parser
    - cookie-parser
    - dotenv
    - debug
    - jsonwebtoken
    - mysql2

- name: add tsconfig.json
  copy:
    src: "roles/node/files/tsconfig.json"
    dest: "/opt/node/expressApp"
    owner: root
    group: root
    mode: 0644

- name: add script[start] in package.json
  lineinfile:
    path: /opt/server/package.json
    regexp: '^(.*)"start": "node ./bin/www"'
    line: "{{ item.line }}"
  loop:
    - { line: '    "start": "node ./dist/bin/app.js",' }

- name: add script[nodemon] & [build] & [watch]in package.json
  lineinfile:
    path: /opt/server/package.json
    insertafter: '^(.*)"start": "node ./dist/bin/app.js"'
    line: "{{ item.line }}"
  loop:
    - { line: '    "nodemon": "nodemon ./dist/bin/app.js"' }
    - { line: '    "build": "tsc",' }
    - { line: '    "db:migrate": "sequelize-cli db:migrate",' }
    - { line: '    "db:seed": "sequelize-cli db:seed:all",' }
    - { line: '    "db:drop": "sequelize-cli db:drop",' }
    - { line: '    "db:create": "sequelize-cli db:create",' }
    - { line: '    "db:reset": "sequelize-cli db:drop && sequelize-cli db:create && sequelize-cli db:migrate",' }

